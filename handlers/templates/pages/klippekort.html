{{define "content"}}
<style>
    /* Top section with existing klippekort and charges */
    .top-section {
        margin-bottom: 3rem;
    }
    
    /* Step 1: Category Selection */
    .step {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        border: 1px solid #e0e0e0;
    }
    .step-title {
        font-size: 1.5rem;
        margin-bottom: 1.5rem;
        color: #333;
        text-align: center;
    }
    
    .section-group-title {
        font-size: 1.8rem;
        margin: 2rem auto 1.5rem auto;
        max-width: 1200px;
        padding: 0 2rem;
        color: #333;
        font-weight: 600;
        text-align: center;
    }
    .categories-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    .category-card {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        transition: transform 0.2s, box-shadow 0.2s;
        cursor: pointer;
        border: 2px solid transparent;
        text-align: center;
    }
    .category-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        border-color: #007cba;
    }
    .category-card.selected {
        border-color: #007cba;
        background-color: #f0f8ff;
    }
    .category-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
        color: #007cba;
    }
    .category-name {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #333;
    }
    .category-description {
        color: #666;
        font-size: 0.9rem;
    }
    
    /* Step 2: Package Selection */
    .packages-section {
        display: none;
        margin-top: 3rem;
        background: white;
        border-radius: 12px;
        padding: 2rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        border: 1px solid #e0e0e0;
    }
    .packages-section.active {
        display: block;
    }
    .packages-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    .package-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        transition: transform 0.2s, box-shadow 0.2s;
        position: relative;
        border: 2px solid transparent;
        cursor: pointer;
    }
    .package-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        border-color: #007cba;
    }
    .package-card.selected {
        border-color: #007cba;
        background-color: #f0f8ff;
    }
    .package-card.popular {
        border-color: #ff6b35;
    }
    .popular-badge {
        position: absolute;
        top: -10px;
        right: 15px;
        background: #ff6b35;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 600;
    }
    .package-name {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #333;
    }
    .package-description {
        color: #666;
        margin-bottom: 1rem;
        font-size: 0.9rem;
    }
    .package-details {
        margin-bottom: 1.5rem;
    }
    .package-price {
        font-size: 1.8rem;
        font-weight: 700;
        color: #007cba;
        margin-bottom: 0.5rem;
    }
    .package-count {
        font-size: 1rem;
        color: #666;
        margin-bottom: 0.5rem;
    }
    .price-per-session {
        font-size: 0.9rem;
        color: #333;
        font-weight: 500;
    }
    .savings {
        color: #27ae60;
        font-weight: 600;
        font-size: 0.9rem;
        margin-top: 0.5rem;
    }
    
    /* Purchase Section */
    .purchase-section {
        display: none;
        margin-top: 3rem;
        padding: 2rem;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .purchase-section.active {
        display: block;
    }
    .purchase-title {
        font-size: 1.5rem;
        margin-bottom: 1rem;
        color: #333;
        text-align: center;
    }
    .selected-details {
        background: #f0f8ff;
        padding: 1.5rem;
        border-radius: 8px;
        margin-bottom: 2rem;
        text-align: center;
    }
    .selected-details h3 {
        font-size: 1.25rem;
        margin-bottom: 0.5rem;
        color: #007cba;
    }
    .selected-details .price {
        font-size: 2rem;
        font-weight: 700;
        color: #007cba;
        margin: 1rem 0;
    }
    .purchase-btn {
        width: 100%;
        padding: 1rem 2rem;
        background-color: #007cba;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .purchase-btn:hover {
        background-color: #005a87;
    }
    
    @media (max-width: 768px) {
        .categories-grid, .packages-grid {
            grid-template-columns: 1fr;
        }
        
        .top-section {
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }
    }
</style>

{{template "navigation" .}}

<main class="main">
    <h1 class="page-title">Behandle klipp</h1>
    <p class="page-description">
        Rediger dette seinere.
    </p>
    
    <!-- Top section with user's existing klippekort and charges -->
    <div class="top-section two-column-grid">
        <div class="module no-border klippekort-mine-module">
            <h2 class="module-title">Klippekorta mine</h2>
            <div id="user-klippekort-container">
                <!-- This will be loaded via AJAX -->
                <div class="loading-placeholder">Laster klippekort...</div>
            </div>
        </div>
        
        <div class="module no-border charges-module">
            <h2 class="module-title">Belastninger</h2>
            <div id="klippekort-charges-container">
                <div class="loading-placeholder">Laster belastninger...</div>
            </div>
        </div>
    </div>
    
    <!-- Step 1: Category Selection -->
    <h1 class="page-title">Kj√∏p klipp</h1>
    <p class="page-description">
        Velg type trening og antall klipp. Jo flere klipp du kj√∏per, desto mindre blir prisen per √∏kt.
    </p>
    <div class="step" id="step1">
        <h2 class="step-title">Steg 1: Velg type trening</h2>
        <div class="categories-grid">
            <div class="category-card" data-category="gruppetimer-sal" onclick="selectCategory('gruppetimer-sal')">
                <div class="category-icon">üßò‚Äç‚ôÄÔ∏è</div>
                <h3 class="category-name">Gruppetimer Sal</h3>
                <p class="category-description">Yoga, Pilates Mat, og andre sal-baserte gruppetimer</p>
            </div>
            
            <div class="category-card" data-category="reformer-apparatus" onclick="selectCategory('reformer-apparatus')">
                <div class="category-icon">üí™</div>
                <h3 class="category-name">Reformer/Apparatus</h3>
                <p class="category-description">Spesialisert Pilates utstyr og apparatus-trening</p>
            </div>
            
            <div class="category-card" data-category="self-practice" onclick="selectCategory('self-practice')">
                <div class="category-icon">üèÉ‚Äç‚ôÇÔ∏è</div>
                <h3 class="category-name">Self Practice Pilates Apparatus</h3>
                <p class="category-description">Selvstendig trening p√• Pilates apparatus</p>
            </div>
            
            <div class="category-card" data-category="online-gruppetimer" onclick="selectCategory('online-gruppetimer')">
                <div class="category-icon">üíª</div>
                <h3 class="category-name">Online Gruppetimer</h3>
                <p class="category-description">Live streaming og on-demand klasser</p>
            </div>
            
            <div class="category-card" data-category="personlig-trening" onclick="selectCategory('personlig-trening')">
                <div class="category-icon">üë®‚Äçüíº</div>
                <h3 class="category-name">Personlig Trening</h3>
                <p class="category-description">One-on-one trening med personlig trener</p>
            </div>
            
            <div class="category-card" data-category="stressmestring" onclick="selectCategory('stressmestring')">
                <div class="category-icon">üß†</div>
                <h3 class="category-name">Stressmestring</h3>
                <p class="category-description">Avslapning, meditasjon og stressh√•ndtering</p>
            </div>
        </div>
    </div>
    
    <!-- Step 2: Package Selection for each category -->
    <div class="packages-section" id="packages-gruppetimer-sal">
        <h2 class="step-title">Steg 2: Velg antall klipp for Gruppetimer Sal</h2>
        <div class="packages-grid">
            <div class="package-card" data-package="gruppetimer-1" data-package-id="1" onclick="selectPackage('gruppetimer-sal', 1, 250, 'Pr√∏v en gang')">
                <h3 class="package-name">1 klipp</h3>
                <p class="package-description">Pr√∏v en gang</p>
                <div class="package-details">
                    <div class="package-price">250 kr</div>
                    <div class="package-count">1 klipp</div>
                    <div class="price-per-session">250 kr per √∏kt</div>
                </div>
            </div>
            
            <div class="package-card" data-package="gruppetimer-5" data-package-id="2" onclick="selectPackage('gruppetimer-sal', 5, 1100, 'Perfekt for √• pr√∏ve ut')">
                <h3 class="package-name">5 klipp</h3>
                <p class="package-description">Perfekt for √• pr√∏ve ut</p>
                <div class="package-details">
                    <div class="package-price">1100 kr</div>
                    <div class="package-count">5 klipp</div>
                    <div class="price-per-session">220 kr per √∏kt</div>
                    <div class="savings">Spar 150 kr!</div>
                </div>
            </div>
            
            <div class="package-card popular" data-package="gruppetimer-10" data-package-id="3" onclick="selectPackage('gruppetimer-sal', 10, 2000, 'Mest popul√¶re pakke')">
                <div class="popular-badge">Mest popul√¶r</div>
                <h3 class="package-name">10 klipp</h3>
                <p class="package-description">Mest popul√¶re pakke</p>
                <div class="package-details">
                    <div class="package-price">2000 kr</div>
                    <div class="package-count">10 klipp</div>
                    <div class="price-per-session">200 kr per √∏kt</div>
                    <div class="savings">Spar 500 kr!</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Reformer/Apparatus packages -->
    <div class="packages-section" id="packages-reformer-apparatus">
        <h2 class="step-title">Steg 2: Velg antall klipp for Reformer/Apparatus</h2>
        <div class="packages-grid">
            <div class="package-card" data-package="reformer-1" data-package-id="4" onclick="selectPackage('reformer-apparatus', 1, 300, 'Pr√∏v en gang')">
                <h3 class="package-name">1 klipp</h3>
                <p class="package-description">Pr√∏v en gang</p>
                <div class="package-details">
                    <div class="package-price">300 kr</div>
                    <div class="package-count">1 klipp</div>
                    <div class="price-per-session">300 kr per √∏kt</div>
                </div>
            </div>
            
            <div class="package-card" data-package="reformer-5" data-package-id="5" onclick="selectPackage('reformer-apparatus', 5, 1400, 'Perfekt for √• pr√∏ve ut')">
                <h3 class="package-name">5 klipp</h3>
                <p class="package-description">Perfekt for √• pr√∏ve ut</p>
                <div class="package-details">
                    <div class="package-price">1400 kr</div>
                    <div class="package-count">5 klipp</div>
                    <div class="price-per-session">280 kr per √∏kt</div>
                    <div class="savings">Spar 100 kr!</div>
                </div>
            </div>
            
            <div class="package-card popular" data-package="reformer-10" data-package-id="6" onclick="selectPackage('reformer-apparatus', 10, 2500, 'Mest popul√¶re pakke')">
                <div class="popular-badge">Mest popul√¶r</div>
                <h3 class="package-name">10 klipp</h3>
                <p class="package-description">Mest popul√¶re pakke</p>
                <div class="package-details">
                    <div class="package-price">2500 kr</div>
                    <div class="package-count">10 klipp</div>
                    <div class="price-per-session">250 kr per √∏kt</div>
                    <div class="savings">Spar 500 kr!</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Self Practice packages -->
    <div class="packages-section" id="packages-self-practice">
        <h2 class="step-title">Steg 2: Velg antall klipp for Self Practice Pilates Apparatus</h2>
        <div class="packages-grid">
            <div class="package-card" data-package="self-practice-5" onclick="selectPackage('self-practice', 5, 800, 'Perfekt for √• pr√∏ve ut')">
                <h3 class="package-name">5 klipp</h3>
                <p class="package-description">Perfekt for √• pr√∏ve ut</p>
                <div class="package-details">
                    <div class="package-price">800 kr</div>
                    <div class="package-count">5 klipp</div>
                    <div class="price-per-session">160 kr per √∏kt</div>
                </div>
            </div>
            
            <div class="package-card popular" data-package="self-practice-10" onclick="selectPackage('self-practice', 10, 1400, 'Mest popul√¶re pakke')">
                <div class="popular-badge">Mest popul√¶r</div>
                <h3 class="package-name">10 klipp</h3>
                <p class="package-description">Mest popul√¶re pakke</p>
                <div class="package-details">
                    <div class="package-price">1400 kr</div>
                    <div class="package-count">10 klipp</div>
                    <div class="price-per-session">140 kr per √∏kt</div>
                    <div class="savings">Spar 200 kr!</div>
                </div>
            </div>
            
            <div class="package-card" data-package="self-practice-20" onclick="selectPackage('self-practice', 20, 2400, 'Beste verdi')">
                <h3 class="package-name">20 klipp</h3>
                <p class="package-description">Beste verdi</p>
                <div class="package-details">
                    <div class="package-price">2400 kr</div>
                    <div class="package-count">20 klipp</div>
                    <div class="price-per-session">120 kr per √∏kt</div>
                    <div class="savings">Spar 800 kr!</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Online Gruppetimer packages -->
    <div class="packages-section" id="packages-online-gruppetimer">
        <h2 class="step-title">Steg 2: Velg antall klipp for Online Gruppetimer</h2>
        <div class="packages-grid">
            <div class="package-card" data-package="online-5" onclick="selectPackage('online-gruppetimer', 5, 600, 'Perfekt for √• pr√∏ve ut')">
                <h3 class="package-name">5 klipp</h3>
                <p class="package-description">Perfekt for √• pr√∏ve ut</p>
                <div class="package-details">
                    <div class="package-price">600 kr</div>
                    <div class="package-count">5 klipp</div>
                    <div class="price-per-session">120 kr per √∏kt</div>
                </div>
            </div>
            
            <div class="package-card popular" data-package="online-10" onclick="selectPackage('online-gruppetimer', 10, 1000, 'Mest popul√¶re pakke')">
                <div class="popular-badge">Mest popul√¶r</div>
                <h3 class="package-name">10 klipp</h3>
                <p class="package-description">Mest popul√¶re pakke</p>
                <div class="package-details">
                    <div class="package-price">1000 kr</div>
                    <div class="package-count">10 klipp</div>
                    <div class="price-per-session">100 kr per √∏kt</div>
                    <div class="savings">Spar 200 kr!</div>
                </div>
            </div>
            
            <div class="package-card" data-package="online-20" onclick="selectPackage('online-gruppetimer', 20, 1600, 'Beste verdi')">
                <h3 class="package-name">20 klipp</h3>
                <p class="package-description">Beste verdi</p>
                <div class="package-details">
                    <div class="package-price">1600 kr</div>
                    <div class="package-count">20 klipp</div>
                    <div class="price-per-session">80 kr per √∏kt</div>
                    <div class="savings">Spar 800 kr!</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Personlig Trening packages -->
    <div class="packages-section" id="packages-personlig-trening">
        <h2 class="step-title">Steg 2: Velg antall klipp for Personlig Trening</h2>
        <div class="packages-grid">
            <div class="package-card" data-package="personlig-5" onclick="selectPackage('personlig-trening', 5, 4500, 'Perfekt for √• pr√∏ve ut')">
                <h3 class="package-name">5 klipp</h3>
                <p class="package-description">Perfekt for √• pr√∏ve ut</p>
                <div class="package-details">
                    <div class="package-price">4500 kr</div>
                    <div class="package-count">5 klipp</div>
                    <div class="price-per-session">900 kr per √∏kt</div>
                </div>
            </div>
            
            <div class="package-card popular" data-package="personlig-10" onclick="selectPackage('personlig-trening', 10, 8000, 'Mest popul√¶re pakke')">
                <div class="popular-badge">Mest popul√¶r</div>
                <h3 class="package-name">10 klipp</h3>
                <p class="package-description">Mest popul√¶re pakke</p>
                <div class="package-details">
                    <div class="package-price">8000 kr</div>
                    <div class="package-count">10 klipp</div>
                    <div class="price-per-session">800 kr per √∏kt</div>
                    <div class="savings">Spar 1000 kr!</div>
                </div>
            </div>
            
            <div class="package-card" data-package="personlig-20" onclick="selectPackage('personlig-trening', 20, 14000, 'Beste verdi')">
                <h3 class="package-name">20 klipp</h3>
                <p class="package-description">Beste verdi</p>
                <div class="package-details">
                    <div class="package-price">14000 kr</div>
                    <div class="package-count">20 klipp</div>
                    <div class="price-per-session">700 kr per √∏kt</div>
                    <div class="savings">Spar 4000 kr!</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Stressmestring packages -->
    <div class="packages-section" id="packages-stressmestring">
        <h2 class="step-title">Steg 2: Velg antall klipp for Stressmestring</h2>
        <div class="packages-grid">
            <div class="package-card" data-package="stress-5" onclick="selectPackage('stressmestring', 5, 750, 'Perfekt for √• pr√∏ve ut')">
                <h3 class="package-name">5 klipp</h3>
                <p class="package-description">Perfekt for √• pr√∏ve ut</p>
                <div class="package-details">
                    <div class="package-price">750 kr</div>
                    <div class="package-count">5 klipp</div>
                    <div class="price-per-session">150 kr per √∏kt</div>
                </div>
            </div>
            
            <div class="package-card popular" data-package="stress-10" onclick="selectPackage('stressmestring', 10, 1300, 'Mest popul√¶re pakke')">
                <div class="popular-badge">Mest popul√¶r</div>
                <h3 class="package-name">10 klipp</h3>
                <p class="package-description">Mest popul√¶re pakke</p>
                <div class="package-details">
                    <div class="package-price">1300 kr</div>
                    <div class="package-count">10 klipp</div>
                    <div class="price-per-session">130 kr per √∏kt</div>
                    <div class="savings">Spar 200 kr!</div>
                </div>
            </div>
            
            <div class="package-card" data-package="stress-20" onclick="selectPackage('stressmestring', 20, 2200, 'Beste verdi')">
                <h3 class="package-name">20 klipp</h3>
                <p class="package-description">Beste verdi</p>
                <div class="package-details">
                    <div class="package-price">2200 kr</div>
                    <div class="package-count">20 klipp</div>
                    <div class="price-per-session">110 kr per √∏kt</div>
                    <div class="savings">Spar 800 kr!</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Purchase Section -->
    <div class="purchase-section" id="purchase-section">
        <h2 class="purchase-title">Bekreft ditt valg</h2>
        <div class="selected-details">
            <h3 id="selected-package-name"></h3>
            <p id="selected-package-description"></p>
            <div class="price" id="selected-package-price"></div>
            <p id="selected-package-details"></p>
        </div>
        <button class="purchase-btn" onclick="purchasePackage()">Kj√∏p klippekort</button>
    </div>
</main>

<script>
    let selectedCategory = null;
    let selectedPackage = null;
    
    function selectCategory(category) {
        // Clear previous selections
        document.querySelectorAll('.category-card').forEach(card => {
            card.classList.remove('selected');
        });
        document.querySelectorAll('.packages-section').forEach(section => {
            section.classList.remove('active');
        });
        document.getElementById('purchase-section').classList.remove('active');
        
        // Select new category
        document.querySelector('.category-card[data-category="' + category + '"]').classList.add('selected');
        const packagesSection = document.getElementById('packages-' + category);
        if (packagesSection) {
            packagesSection.classList.add('active');
            packagesSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        selectedCategory = category;
        selectedPackage = null;
    }
    
    function selectPackage(category, clips, price, description) {
        // Clear previous package selections
        document.querySelectorAll('.package-card').forEach(card => {
            card.classList.remove('selected');
        });
        
        // Select new package
        event.currentTarget.classList.add('selected');
        
        selectedPackage = {
            category: category,
            clips: clips,
            price: price,
            description: description,
            pricePerSession: price / clips
        };
        
        // Update purchase section
        const categoryNames = {
            'gruppetimer-sal': 'Gruppetimer Sal',
            'reformer-apparatus': 'Reformer/Apparatus',
            'self-practice': 'Self Practice Pilates Apparatus',
            'online-gruppetimer': 'Online Gruppetimer',
            'personlig-trening': 'Personlig Trening',
            'stressmestring': 'Stressmestring'
        };
        
        document.getElementById('selected-package-name').textContent = clips + ' klipp ' + categoryNames[category];
        document.getElementById('selected-package-description').textContent = description;
        document.getElementById('selected-package-price').textContent = price + ' kr';
        document.getElementById('selected-package-details').textContent = clips + ' klipp ‚Ä¢ ' + Math.round(selectedPackage.pricePerSession) + ' kr per √∏kt';
        
        // Show purchase section
        document.getElementById('purchase-section').classList.add('active');
        document.getElementById('purchase-section').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    function purchasePackage() {
        if (!selectedPackage) {
            alert('Vennligst velg en pakke f√∏rst');
            return;
        }
        
        // Show alert about Stripe integration being incomplete
        alert('Betalingsintegrasjon er ikke komplett. Stripe-integrasjon er under utvikling. Klippekort: ' + selectedPackage.clips + ' klipp for ' + selectedPackage.price + ' kr');
        
        // Find the package ID based on selected package details
        let packageId = null;
        document.querySelectorAll('.package-card').forEach(card => {
            if (card.classList.contains('selected')) {
                packageId = card.getAttribute('data-package-id');
            }
        });
        
        if (!packageId) {
            alert('Kunne ikke finne pakke-ID');
            return;
        }
        
        if (!confirm('Er du sikker p√• at du vil kj√∏pe ' + selectedPackage.clips + ' klipp for ' + selectedPackage.price + ' kr?')) {
            return;
        }
        
        // Call purchase API
        fetch('/api/klippekort/purchase', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'package_id=' + encodeURIComponent(packageId)
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            } else {
                return response.text().then(text => {
                    throw new Error(text);
                });
            }
        })
        .then(data => {
            alert('Klippekort kj√∏pt! ' + selectedPackage.clips + ' klipp for ' + selectedPackage.price + ' kr');
            // Reload the user's klippekort display
            loadUserKlippekort();
            loadKlippekortCharges();
            // Clear the selection
            document.querySelectorAll('.package-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.getElementById('purchase-section').classList.remove('active');
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Feil ved kj√∏p av klippekort: ' + error.message);
        });
    }
    
    async function loadUserKlippekort() {
        try {
            const response = await fetch('/api/user/klippekort');
            if (response.ok) {
                const html = await response.text();
                document.getElementById('user-klippekort-container').innerHTML = html;
            }
        } catch (error) {
            console.error('Error loading user klippekort:', error);
            document.getElementById('user-klippekort-container').innerHTML = '<div class="error">Kunne ikke laste klippekort</div>';
        }
    }
    
    async function loadKlippekortCharges() {
        try {
            const response = await fetch('/api/charges?type=klippekort');
            if (response.ok) {
                const html = await response.text();
                document.getElementById('klippekort-charges-container').innerHTML = html;
            }
        } catch (error) {
            console.error('Error loading charges:', error);
            document.getElementById('klippekort-charges-container').innerHTML = '<div class="error">Kunne ikke laste belastninger</div>';
        }
    }
    
    // Load data when page loads
    document.addEventListener('DOMContentLoaded', function() {
        loadUserKlippekort();
        loadKlippekortCharges();
        
        // Check if we have a fill parameter to auto-select a category
        const urlParams = new URLSearchParams(window.location.search);
        const fillCategory = urlParams.get('fill');
        if (fillCategory) {
            // Map category names to category IDs
            const categoryMap = {
                'Gruppetimer Sal': 'gruppetimer-sal',
                'Reformer/Apparatus': 'reformer-apparatus',
                'Self Practice Pilates Apparatus': 'self-practice',
                'Online Gruppetimer': 'online-gruppetimer',
                'Personlig Trening': 'personlig-trening',
                'Stressmestring': 'stressmestring'
            };
            
            const categoryId = categoryMap[fillCategory];
            if (categoryId) {
                selectCategory(categoryId);
                // Pre-select the 10 klipp option (highest allowed)
                setTimeout(() => {
                    const tenKlippCard = document.querySelector(`#packages-${categoryId} .package-card[data-package*="10"]`);
                    if (tenKlippCard) {
                        tenKlippCard.click();
                    }
                }, 100);
            }
        }
    });
    
    // Function called from dashboard to fill up klippekort
    function fillUpKlippekort(category) {
        // Auto-select category and jump to 10 klipp option
        window.location.href = '/elev/klippekort?fill=' + encodeURIComponent(category) + '#kjop-klipp';
    }
</script>
{{end}}