{{define "content"}}
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: #f5f5f5;
        color: #333;
    }
    .main-content {
        max-width: 1200px;
        margin: 2rem auto;
        padding: 0 2rem;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
    }
    .page-title {
        font-size: 2rem;
        margin: 2rem auto 1rem auto;
        max-width: 1200px;
        padding: 0 2rem;
        color: #333;
        font-weight: 600;
        border-bottom: 2px solid #007cba;
        padding-bottom: 0.5rem;
    }
    .content-section {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .section-title {
        margin-bottom: 1rem;
        color: #333;
        font-size: 1.25rem;
        font-weight: 600;
        border-bottom: 2px solid #007cba;
        padding-bottom: 0.5rem;
    }
    .events-grid {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        max-height: 400px;
        overflow-y: auto;
        padding: 1.25rem; /* Increased padding to accommodate expanded card shadows (20px) */
        margin: -1.25rem; /* Negative margin to counteract padding and maintain alignment */
    }
    .events-grid::-webkit-scrollbar {
        width: 6px;
    }
    .events-grid::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }
    .events-grid::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 3px;
    }
    .events-grid::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }
    .activity-placeholder {
        text-align: center;
        color: #666;
        font-style: italic;
        padding: 2rem;
    }
    .timeplan-btn {
        display: inline-block;
        background-color: #007cba;
        color: white;
        text-decoration: none;
        padding: 0.75rem 1.5rem;
        border-radius: 6px;
        font-weight: 500;
        transition: background-color 0.2s;
        margin-top: 1rem;
    }
    .timeplan-btn:hover {
        background-color: #005a87;
        color: white;
        text-decoration: none;
    }
    
    /* Responsive styles */
    @media (max-width: 767px) {
        .main-content {
            padding: 1rem;
            grid-template-columns: 1fr;
        }
        .page-title {
            padding: 0 1rem;
        }
    }
</style>

{{template "navigation" .}}

<h1 class="page-title">Velkommen, {{.UserName}}!</h1>

<div class="main-content">
    <div class="content-section">
        <h2 class="section-title">Påmeldt</h2>
        <div class="events-grid" id="signed-up-classes">
            <div class="activity-placeholder">
                Du er ikke påmeldt noen klasser ennå
                <br><br>
                <a href="/elev/timeplan" class="timeplan-btn">Se timeplan</a>
            </div>
        </div>
    </div>
    
    <div class="content-section">
        <h2 class="section-title">Dagens klasser</h2>
        <div class="events-grid" id="todays-classes">
            {{if .TodaysEvents}}
                {{range .TodaysEvents}}
                {{template "event_card" .}}
                {{end}}
            {{else}}
                <div class="activity-placeholder">Ingen kommende klasser i dag</div>
            {{end}}
        </div>
    </div>
    
    <div class="content-section">
        <h2 class="section-title">Mitt medlemskap</h2>
        <div id="membership-container">
            <div class="activity-placeholder">Laster medlemskap...</div>
        </div>
    </div>
    
    <div class="content-section">
        <h2 class="section-title">Mine klippekort</h2>
        <div id="klippekort-container">
            <div class="activity-placeholder">Laster klippekort...</div>
        </div>
    </div>
</div>

<script>
    // Track signed up classes
    let signedUpClasses = new Set();

    function toggleEventCard(element) {
        const isExpanded = element.classList.contains('expanded');
        
        // Close all other expanded cards first
        document.querySelectorAll('.event-card.expanded').forEach(card => {
            if (card !== element) {
                card.classList.remove('expanded');
            }
        });
        
        // Toggle the clicked card
        if (isExpanded) {
            element.classList.remove('expanded');
        } else {
            element.classList.add('expanded');
        }
    }

    function signupForClass(eventId) {
        // Check if already signed up
        if (signedUpClasses.has(eventId)) {
            alert('Du er allerede påmeldt denne klassen!');
            return;
        }

        // Find the event card
        const eventCard = document.querySelector(`[data-event-id="${eventId}"]`);
        if (!eventCard) {
            alert('Kunne ikke finne klassen. Prøv å laste siden på nytt.');
            return;
        }

        // Add to signed up set
        signedUpClasses.add(eventId);

        // Clone the card for the signed-up section
        const clonedCard = eventCard.cloneNode(true);
        clonedCard.classList.remove('expanded');
        
        // Update the signup button in the cloned card
        const signupButton = clonedCard.querySelector('.signup-button');
        if (signupButton) {
            signupButton.textContent = 'Påmeldt ✓';
            signupButton.style.background = '#28a745';
            signupButton.onclick = () => cancelSignup(eventId);
        }

        // Remove from today's classes
        eventCard.style.transform = 'translateX(100%)';
        eventCard.style.opacity = '0';
        
        setTimeout(() => {
            eventCard.remove();
            
            // Add to signed-up section
            const signedUpContainer = document.getElementById('signed-up-classes');
            if (signedUpContainer.querySelector('.activity-placeholder')) {
                signedUpContainer.innerHTML = '';
            }
            
            // Add animation for the new card
            clonedCard.style.transform = 'translateX(-100%)';
            clonedCard.style.opacity = '0';
            signedUpContainer.appendChild(clonedCard);
            
            // Animate in
            setTimeout(() => {
                clonedCard.style.transform = 'translateX(0)';
                clonedCard.style.opacity = '1';
            }, 50);
            
            // Check if today's classes is empty
            const todaysContainer = document.getElementById('todays-classes');
            if (todaysContainer.children.length === 0) {
                todaysContainer.innerHTML = '<div class="activity-placeholder">Ingen kommende klasser i dag</div>';
            }
        }, 300);
    }

    function cancelSignup(eventId) {
        if (!signedUpClasses.has(eventId)) {
            return;
        }

        signedUpClasses.delete(eventId);

        // Find and remove from signed-up section
        const signedUpCard = document.querySelector(`#signed-up-classes [data-event-id="${eventId}"]`);
        if (signedUpCard) {
            signedUpCard.style.transform = 'translateX(-100%)';
            signedUpCard.style.opacity = '0';
            
            setTimeout(() => {
                signedUpCard.remove();
                
                // Check if signed-up section is empty
                const signedUpContainer = document.getElementById('signed-up-classes');
                if (signedUpContainer.children.length === 0) {
                    signedUpContainer.innerHTML = '<div class="activity-placeholder">Du er ikke påmeldt noen klasser ennå<br><br><a href="/elev/timeplan" class="timeplan-btn">Se timeplan</a></div>';
                }
            }, 300);
        }

        // TODO: Add back to today's classes if it's still today
        alert('Avmelding fullført. Klassen vises igjen i "Dagens klasser" hvis den fortsatt er i dag.');
    }

    async function loadMembership() {
        try {
            const response = await fetch('/api/user/membership');
            if (response.ok) {
                const html = await response.text();
                document.getElementById('membership-container').innerHTML = html;
            } else {
                document.getElementById('membership-container').innerHTML = '<div class="error">Kunne ikke laste medlemskap</div>';
            }
        } catch (error) {
            console.error('Error loading membership:', error);
            document.getElementById('membership-container').innerHTML = '<div class="error">Kunne ikke laste medlemskap</div>';
        }
    }

    async function loadKlippekort() {
        try {
            const response = await fetch('/api/user/klippekort');
            if (response.ok) {
                const html = await response.text();
                document.getElementById('klippekort-container').innerHTML = html;
            } else {
                document.getElementById('klippekort-container').innerHTML = '<div class="error">Kunne ikke laste klippekort</div>';
            }
        } catch (error) {
            console.error('Error loading klippekort:', error);
            document.getElementById('klippekort-container').innerHTML = '<div class="error">Kunne ikke laste klippekort</div>';
        }
    }

    // Load components when page loads
    document.addEventListener('DOMContentLoaded', function() {
        loadMembership();
        loadKlippekort();
        
        // Add event IDs to cards for signup functionality
        document.querySelectorAll('.event-card').forEach((card, index) => {
            if (!card.hasAttribute('data-event-id')) {
                card.setAttribute('data-event-id', `event-${index + 1}`);
            }
        });
    });

    // Membership management functions
    async function freezeMembership() {
        if (!confirm('Er du sikker på at du vil fryse medlemskapet ditt?')) {
            return;
        }
        
        try {
            const response = await fetch('/api/membership/freeze', {
                method: 'POST'
            });
            
            if (response.ok) {
                const result = await response.json();
                alert(result.message);
                loadMembership(); // Reload membership display
            } else {
                const errorText = await response.text();
                alert('Feil: ' + errorText);
            }
        } catch (error) {
            console.error('Error freezing membership:', error);
            alert('Feil ved frysing av medlemskap');
        }
    }

    async function cancelFreezeRequest() {
        if (!confirm('Er du sikker på at du vil trekke tilbake frysingsforespørselen?')) {
            return;
        }
        
        try {
            const response = await fetch('/api/membership/cancel-freeze', {
                method: 'POST'
            });
            
            if (response.ok) {
                const result = await response.json();
                alert(result.message);
                loadMembership(); // Reload membership display
            } else {
                const errorText = await response.text();
                alert('Feil: ' + errorText);
            }
        } catch (error) {
            console.error('Error cancelling freeze request:', error);
            alert('Feil ved tilbaketrekking av frysingsforespørsel');
        }
    }

    async function unfreezeMembership() {
        if (!confirm('Er du sikker på at du vil reaktivere medlemskapet ditt?')) {
            return;
        }
        
        try {
            const response = await fetch('/api/membership/unfreeze', {
                method: 'POST'
            });
            
            if (response.ok) {
                const result = await response.json();
                alert(result.message);
                loadMembership(); // Reload membership display
            } else {
                const errorText = await response.text();
                alert('Feil: ' + errorText);
            }
        } catch (error) {
            console.error('Error unfreezing membership:', error);
            alert('Feil ved reaktivering av medlemskap');
        }
    }

    function changeMembership() {
        // Redirect to membership page in "change" mode
        window.location.href = '/elev/medlemskap';
    }

    async function cancelMembership() {
        if (!confirm('Er du sikker på at du vil si opp medlemskapet ditt? Dette kan ikke angres.')) {
            return;
        }
        
        try {
            const response = await fetch('/api/membership/remove', {
                method: 'POST'
            });
            
            if (response.ok) {
                const result = await response.json();
                alert(result.message);
                loadMembership(); // Reload membership display
            } else {
                const errorText = await response.text();
                alert('Feil: ' + errorText);
            }
        } catch (error) {
            console.error('Error cancelling membership:', error);
            alert('Feil ved oppsigelse av medlemskap');
        }
    }

    // Membership management functions (global scope for HTMX-loaded content)
    function freezeMembership() {
        if (confirm('Er du sikker på at du vil fryse medlemskapet?')) {
            fetch('/api/membership/freeze', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => {
                if (response.ok) {
                    // Reload the membership component
                    loadMembership();
                } else {
                    alert('Feil ved frysing av medlemskap');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Feil ved frysing av medlemskap');
            });
        }
    }

    function cancelFreezeRequest() {
        if (confirm('Er du sikker på at du vil trekke tilbake forespørselen om frysing?')) {
            fetch('/api/membership/cancel-freeze', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => {
                if (response.ok) {
                    // Reload the membership component
                    loadMembership();
                } else {
                    alert('Feil ved trekking av forespørsel');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Feil ved trekking av forespørsel');
            });
        }
    }

    function unfreezeMembership() {
        if (confirm('Er du sikker på at du vil smelte/reaktivere medlemskapet?')) {
            fetch('/api/membership/unfreeze', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => {
                if (response.ok) {
                    // Reload the membership component
                    loadMembership();
                } else {
                    alert('Feil ved reaktivering av medlemskap');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Feil ved reaktivering av medlemskap');
            });
        }
    }

    function cancelMembership() {
        if (confirm('Er du sikker på at du vil si opp medlemskapet? Dette kan ikke angres.')) {
            // TODO: Implement cancellation functionality
            alert('Oppsigelse-funksjonalitet kommer snart!');
        }
    }
</script>
{{end}}