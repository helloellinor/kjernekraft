{{define "dashboard_scripts"}}
<script>
    // Load localized text
    const DASHBOARD_TEXTS = {
        alreadySignedUp: {{t .Lang "dashboard.already_signed_up" | toJS}},
        couldNotFindClass: {{t .Lang "dashboard.could_not_find_class" | toJS}},
        signedUpCheckmark: {{t .Lang "dashboard.signed_up_checkmark" | toJS}},
        cancellationComplete: {{t .Lang "dashboard.cancellation_complete" | toJS}},
        noSignedUpClasses: {{t .Lang "dashboard.no_signed_up_classes" | toJS}},
        seeSchedule: {{t .Lang "dashboard.see_schedule" | toJS}},
        noClassesToday: {{t .Lang "dashboard.no_classes_today" | toJS}},
        couldNotLoadMembership: {{t .Lang "dashboard.could_not_load_membership" | toJS}},
        couldNotLoadPunchCards: {{t .Lang "dashboard.could_not_load_punch_cards" | toJS}},
        freezeConfirm: {{t .Lang "membership_actions.freeze_confirm" | toJS}},
        cancelFreezeConfirm: {{t .Lang "membership_actions.cancel_freeze_confirm" | toJS}},
        unfreezeConfirm: {{t .Lang "membership_actions.unfreeze_confirm" | toJS}},
        cancelMembershipConfirm: {{t .Lang "membership_actions.cancel_membership_confirm" | toJS}},
        freezeError: {{t .Lang "membership_actions.freeze_error" | toJS}},
        cancelFreezeError: {{t .Lang "membership_actions.cancel_freeze_error" | toJS}},
        unfreezeError: {{t .Lang "membership_actions.unfreeze_error" | toJS}},
        cancelMembershipError: {{t .Lang "membership_actions.cancel_membership_error" | toJS}},
        errorPrefix: {{t .Lang "membership_actions.error_prefix" | toJS}}
    };

    // Track signed up classes
    let signedUpClasses = new Set();

    function toggleEventCard(element) {
        const isExpanded = element.classList.contains('expanded');
        
        // Close all other expanded cards first
        document.querySelectorAll('.event-card.expanded').forEach(card => {
            if (card !== element) {
                card.classList.remove('expanded');
            }
        });
        
        // Toggle the clicked card
        if (isExpanded) {
            element.classList.remove('expanded');
        } else {
            element.classList.add('expanded');
        }
    }

    function signupForClass(eventId) {
        // Check if already signed up
        if (signedUpClasses.has(eventId)) {
            alert(DASHBOARD_TEXTS.alreadySignedUp);
            return;
        }

        // Find the event card
        const eventCard = document.querySelector(`[data-event-id="${eventId}"]`);
        if (!eventCard) {
            alert(DASHBOARD_TEXTS.couldNotFindClass);
            return;
        }

        // Add to signed up set
        signedUpClasses.add(eventId);

        // Clone the card for the signed-up section
        const clonedCard = eventCard.cloneNode(true);
        clonedCard.classList.remove('expanded');
        
        // Update the signup button in the cloned card
        const signupButton = clonedCard.querySelector('.signup-button');
        if (signupButton) {
            signupButton.textContent = DASHBOARD_TEXTS.signedUpCheckmark;
            signupButton.style.background = '#28a745';
            signupButton.onclick = () => cancelSignup(eventId);
        }

        // Remove from today's classes
        eventCard.style.transform = 'translateX(100%)';
        eventCard.style.opacity = '0';
        
        setTimeout(() => {
            eventCard.remove();
            
            // Add to signed-up section
            const signedUpContainer = document.getElementById('signed-up-classes');
            if (signedUpContainer.querySelector('.activity-placeholder')) {
                signedUpContainer.innerHTML = '';
            }
            
            // Add animation for the new card
            clonedCard.style.transform = 'translateX(-100%)';
            clonedCard.style.opacity = '0';
            signedUpContainer.appendChild(clonedCard);
            
            // Animate in
            setTimeout(() => {
                clonedCard.style.transform = 'translateX(0)';
                clonedCard.style.opacity = '1';
            }, 50);
            
            // Check if today's classes is empty
            const todaysContainer = document.getElementById('todays-classes');
            if (todaysContainer.children.length === 0) {
                todaysContainer.innerHTML = `<div class="activity-placeholder">${DASHBOARD_TEXTS.noClassesToday}</div>`;
            }
        }, 300);
    }

    function cancelSignup(eventId) {
        if (!signedUpClasses.has(eventId)) {
            return;
        }

        signedUpClasses.delete(eventId);

        // Find and remove from signed-up section
        const signedUpCard = document.querySelector(`#signed-up-classes [data-event-id="${eventId}"]`);
        if (signedUpCard) {
            signedUpCard.style.transform = 'translateX(-100%)';
            signedUpCard.style.opacity = '0';
            
            setTimeout(() => {
                signedUpCard.remove();
                
                // Check if signed-up section is empty
                const signedUpContainer = document.getElementById('signed-up-classes');
                if (signedUpContainer.children.length === 0) {
                    signedUpContainer.innerHTML = `<div class="activity-placeholder">${DASHBOARD_TEXTS.noSignedUpClasses}<br><br><a href="/elev/timeplan" class="timeplan-btn">${DASHBOARD_TEXTS.seeSchedule}</a></div>`;
                }
            }, 300);
        }

        // TODO: Add back to today's classes if it's still today
        alert(DASHBOARD_TEXTS.cancellationComplete);
    }

    async function loadMembership() {
        try {
            const response = await fetch('/api/user/membership');
            if (response.ok) {
                const html = await response.text();
                document.getElementById('membership-container').innerHTML = html;
            } else {
                document.getElementById('membership-container').innerHTML = `<div class="error">${DASHBOARD_TEXTS.couldNotLoadMembership}</div>`;
            }
        } catch (error) {
            console.error('Error loading membership:', error);
            document.getElementById('membership-container').innerHTML = `<div class="error">${DASHBOARD_TEXTS.couldNotLoadMembership}</div>`;
        }
    }

    async function loadKlippekort() {
        try {
            const response = await fetch('/api/user/klippekort');
            if (response.ok) {
                const html = await response.text();
                document.getElementById('klippekort-container').innerHTML = html;
            } else {
                document.getElementById('klippekort-container').innerHTML = `<div class="error">${DASHBOARD_TEXTS.couldNotLoadPunchCards}</div>`;
            }
        } catch (error) {
            console.error('Error loading klippekort:', error);
            document.getElementById('klippekort-container').innerHTML = `<div class="error">${DASHBOARD_TEXTS.couldNotLoadPunchCards}</div>`;
        }
    }

    // Load components when page loads
    document.addEventListener('DOMContentLoaded', function() {
        loadMembership();
        loadKlippekort();
        
        // Add event IDs to cards for signup functionality
        document.querySelectorAll('.event-card').forEach((card, index) => {
            if (!card.hasAttribute('data-event-id')) {
                card.setAttribute('data-event-id', `event-${index + 1}`);
            }
        });
    });

    // Membership management functions
    async function freezeMembership() {
        if (!confirm(DASHBOARD_TEXTS.freezeConfirm)) {
            return;
        }
        
        try {
            const response = await fetch('/api/membership/freeze', {
                method: 'POST'
            });
            
            if (response.ok) {
                const result = await response.json();
                alert(result.message);
                loadMembership(); // Reload membership display
            } else {
                const errorText = await response.text();
                alert(DASHBOARD_TEXTS.errorPrefix + errorText);
            }
        } catch (error) {
            console.error('Error freezing membership:', error);
            alert(DASHBOARD_TEXTS.freezeError);
        }
    }

    async function cancelFreezeRequest() {
        if (!confirm(DASHBOARD_TEXTS.cancelFreezeConfirm)) {
            return;
        }
        
        try {
            const response = await fetch('/api/membership/cancel-freeze', {
                method: 'POST'
            });
            
            if (response.ok) {
                const result = await response.json();
                alert(result.message);
                loadMembership(); // Reload membership display
            } else {
                const errorText = await response.text();
                alert(DASHBOARD_TEXTS.errorPrefix + errorText);
            }
        } catch (error) {
            console.error('Error cancelling freeze request:', error);
            alert(DASHBOARD_TEXTS.cancelFreezeError);
        }
    }

    async function unfreezeMembership() {
        if (!confirm(DASHBOARD_TEXTS.unfreezeConfirm)) {
            return;
        }
        
        try {
            const response = await fetch('/api/membership/unfreeze', {
                method: 'POST'
            });
            
            if (response.ok) {
                const result = await response.json();
                alert(result.message);
                loadMembership(); // Reload membership display
            } else {
                const errorText = await response.text();
                alert(DASHBOARD_TEXTS.errorPrefix + errorText);
            }
        } catch (error) {
            console.error('Error unfreezing membership:', error);
            alert(DASHBOARD_TEXTS.unfreezeError);
        }
    }

    function changeMembership() {
        // Redirect to membership page and scroll to membership selector section
        window.location.href = '/elev/medlemskap#membership-selector';
    }

    async function cancelMembership() {
        if (!confirm(DASHBOARD_TEXTS.cancelMembershipConfirm)) {
            return;
        }
        
        try {
            const response = await fetch('/api/membership/remove', {
                method: 'POST'
            });
            
            if (response.ok) {
                const result = await response.json();
                alert(result.message);
                loadMembership(); // Reload membership display
            } else {
                const errorText = await response.text();
                alert(DASHBOARD_TEXTS.errorPrefix + errorText);
            }
        } catch (error) {
            console.error('Error cancelling membership:', error);
            alert(DASHBOARD_TEXTS.cancelMembershipError);
        }
    }
</script>
{{end}}